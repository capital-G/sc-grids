s.boot;

q = ()

(
q[\drumMap] = ();

q[\drumMap][\kick] = #[
	   [[145,   0,   0,   0,   0,   0, 109,   0,   0,   0,   0,   0, 255,   0, 109,   0,  72,   0, 218,   0,   0,   0,   0,   0,  36,   0,   0,   0, 182,   0,   0,   0],
        [255,   0,   0,   0, 218,   0,   0,   0,  36,   0,   0,   0, 218,   0,   0,   0, 182,   0, 109,   0, 255,   0,   0,   0,   0,   0,   0,   0, 145,   0,  72,   0],
        [255,   0,   0,   0,   0,   0, 145,   0,   0,   0,   0,   0, 218,   0,   0,   0,  72,   0,  36,   0, 182,   0,   0,   0, 109,   0,   0,   0,  72,   0,   0,   0],
        [226,   0,  28,   0,  28,   0, 141,   0,   8,   0,   8,   0, 255,   0,   8,   0, 113,   0,  28,   0, 198,   0,  85,   0,  56,   0, 198,   0, 170,   0,  28,   0],
        [255,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0, 255,   0,   0,   0, 218,   0,  72,  36,   0,   0, 182,   0,   0,   0, 145, 109]],

       [[255,   0,   0,   0,   0,   0,   0,   0,  36,   0,   0,   0, 182,   0,   0,   0, 218,   0,   0,   0,   0,   0,   0,   0,  72,   0,   0,   0, 145,   0, 109,   0],
        [223,   0,   0,   0,  63,   0,   0,   0,  95,   0,   0,   0, 223,   0,  31,   0, 255,   0,   0,   0, 159,   0,   0,   0, 127,   0,  31,   0, 191,   0,  31,   0],
        [255,   0,   0,   0,   0,   0,  63,   0, 191,   0,  95,   0,  31,   0, 223,   0, 255,   0,  63,   0,  95,   0,  63,   0, 159,   0,   0,   0,   0,   0, 127,   0],
        [255,   0,   0,   0, 255,   0, 191,   0,   0,   0,   0,   0,  95,   0,  63,   0,  31,   0,   0,   0, 223,   0, 223,   0,   0,   0,   8,   0, 159,   0, 127,   0],
        [255,   0,   0,   0, 223,   0,   0,   0,  31,   0,   8,   0, 127,   0,   0,   0,  95,   0,   0,   0, 159,   0,   0,   0,  95,   0,  63,   0, 191,   0,   0,   0]],

       [[255,   0,   8,   0,  28,   0,  28,   0, 198,   0,  56,   0,  56,   0,  85,   0, 255,   0,  85,   0, 113,   0, 113,   0, 226,   0, 141,   0, 170,   0, 141,   0],
        [255,   0,   0,   0,  51,   0,   0,   0,   0,   0,   0,   0, 102,   0,   0,   0, 204,   0,   0,   0, 153,   0,   0,   0,   0,   0,   0,   0,  51,   0,   0,   0],
        [255,   0,  31,   0,  63,   0,  63,   0, 127,   0,  95,   0, 191,   0,  63,   0, 223,   0,  31,   0, 159,   0,  63,   0,  31,   0,  63,   0,  95,   0,  31,   0],
        [255,   0,  51,   0,  25,   0,  76,   0,   0,   0,   0,   0, 102,   0,   0,   0, 204,   0, 229,   0,   0,   0, 178,   0,   0,   0, 153,   0, 127,   0,   8,   0],
        [255,   0, 212,   0,  63,   0,   0,   0, 106,   0, 148,   0,  85,   0, 127,   0, 191,   0,  21,   0, 233,   0,   0,   0,  21,   0, 170,   0,   0,   0,  42,   0]],

       [[255,   0,   0,   0, 229,   0,   0,   0, 204,   0, 204,   0,   0,   0,  76,   0, 178,   0, 153,   0,  51,   0, 178,   0, 178,   0, 127,   0, 102,  51,  51,  25],
        [255,   0,   0,   0,   0,   0,  95,   0,   0,   0, 127,   0,   0,   0,   0,   0, 223,   0,  95,   0,  63,   0,  31,   0, 191,   0,   0,   0, 159,   0,   0,   0],
        [255,   0,   0,   0, 218,   0,   0,   0, 145,   0,   0,   0,  36,   0,   0,   0, 218,   0,   0,   0,  36,   0,   0,   0, 182,   0,  72,   0,   0,   0, 109,   0],
        [229,   0,  25,   0, 102,   0,  25,   0, 204,   0,  25,   0,  76,   0,   8,   0, 255,   0,   8,   0,  51,   0,  25,   0, 178,   0,  25,   0, 153,   0, 127,   0],
        [255,   0,   0,   0, 127,   0,   0,   0,   0,   0, 102,   0,   0,   0, 229,   0,   0,   0, 178,   0, 204,   0,   0,   0,  76,   0,  51,   0, 153,   0,  25,   0]],

       [[170,   0,   0,   0,   0, 255,   0,   0, 198,   0,   0,   0,   0,  28,   0,   0, 141,   0,   0,   0,   0, 226,   0,   0,  56,   0,   0, 113,   0,  85,   0,   0],
        [255,   0,   0,   0,   0,   0, 218,   0, 182,   0,   0,   0,   0,   0, 145,   0, 145,   0,  36,   0,   0,   0, 109,   0, 109,   0,   0,   0,  72,   0,  36,   0],
        [255,   0,   0,   0,   8,   0,   0,   0, 182,   0,   0,   0,  72,   0,   0,   0, 218,   0,   0,   0,  36,   0,   0,   0, 145,   0,   0,   0, 109,   0,   0,   0],
        [255,   0,   0,   0, 113,   0,   0,   0, 198,   0,  56,   0,  85,   0,  28,   0, 255,   0,   0,   0, 226,   0,   0,   0, 170,   0,   0,   0, 141,   0,   0,   0],
        [255,   0,   0,   0,  42,   0,   0,   0, 212,   0,   0,   0,   8,   0, 212,   0, 170,   0,   0,   0,  85,   0,   0,   0, 212,   0,   8,   0, 127,   0,   8,   0]]
];


q[\drumMap][\snare] = #[
	   [[  0,   0, 127,   0, 159,   0, 127,   0, 159,   0, 191,   0, 223,   0,  63,   0, 255,   0,  95,   0,  31,   0,  95,   0,  31,   0,   8,   0,  63,   0,   8,   0],
        [159,   0,   0,   0,  31,   0, 127,   0, 255,   0,  31,   0,   0,   0,  95,   0,   8,   0,   0,   0, 191,   0,  31,   0, 255,   0,  31,   0, 223,   0,  63,   0],
        [ 36,   0, 109,   0,   0,   0,   8,   0, 255,   0,   0,   0,   0,   0,  72,   0,   0,   0, 182,   0,   0,   0,  36,   0, 218,   0,   0,   0, 145,   0,   0,   0],
        [  8,   0,  95,   0,   8,   0,   8,   0, 255,   0,  63,   0,  31,   0, 223,   0,   8,   0,  31,   0, 191,   0,   8,   0, 255,   0, 127,   0, 127,   0, 159,   0],
        [  0,   0, 127,   0,   0,   0,  42,   0, 212,   0,   0, 212,   0,   0, 212,   0,   0,   0,   0,   0,  42,   0,   0,   0, 255,   0,   0,   0, 170, 170, 127,  85]],

       [[ 36,   0,  36,   0,   0,   0,   0,   0, 255,   0,   0,   0, 182,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0, 109, 218,   0,   0,   0, 145,   0,  72,  72],
        [  0,   0,   0,   0, 109,   0,   0,   0, 218,   0,   0,   0, 182,   0,  72,   0,   8,   0,  36,   0, 145,   0,  36,   0, 255,   0,   8,   0, 182,   0,  72,   0],
        [ 72,   0,   0,   0,   0,   0,   0,   0, 255,   0,   0,   0,   0,   0,   0,   0,  72,   0,  72,   0,  36,   0,   8,   0, 218,   0, 182,   0, 145,   0, 109,   0],
        [  0,   0,  85,   0,  56,   0,  28,   0, 255,   0,  28,   0,   0,   0, 226,   0,   0,   0, 170,   0,  56,   0, 113,   0, 198,   0,   0,   0, 113,   0, 141,   0],
        [ 51,   0, 204,   0,   0,   0, 102,   0, 255,   0, 127,   0,   8,   0, 178,   0,  25,   0, 229,   0,   0,   0,  76,   0, 204,   0, 153,   0,  51,   0,  25,   0]],

       [[  0,   0,   0,   0,   0,   0,   0,   0, 255,   0,   0,   0, 127,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,  63,   0,   0,   0, 191,   0,   0,   0],
        [  0,   0,   0,   0,   8,   0,  36,   0, 255,   0,   0,   0, 182,   0,   8,   0,   0,   0,   0,   0,  72,   0, 109,   0, 145,   0,   0,   0, 255,   0, 218,   0],
        [  8,   0,   0,   0,  95,   0,  63,   0, 255,   0,   0,   0, 127,   0,   0,   0,   8,   0,   0,   0, 159,   0,  63,   0, 255,   0, 223,   0, 191,   0,  31,   0],
        [178,   0, 127,   0, 153,   0, 204,   0, 255,   0,   0,   0,  25,   0,  76,   0, 102,   0,  51,   0,   0,   0,   0,   0, 229,   0,  25,   0,  25,   0, 204,   0],
        [  0,   0,   0,   0, 141,   0, 113,   0, 255,   0, 198,   0,   0,   0,  56,   0,   0,   0,  85,   0,  56,   0,  28,   0, 226,   0,  28,   0, 170,   0,  56,   0]],

       [[  0,   0,   0,   0,   0,   0,   0,  31,   0,   0,   0,   0, 255,   0,   0,  31,   0,   0,   8,   0,   0,   0, 191, 159, 127,  95,  95,   0, 223,   0,  63,   0],
        [  0,   0,  31,   0, 255,   0,   0,   0,   0,   0,  95,   0, 223,   0,   0,   0,   0,   0,  63,   0, 191,   0,   0,   0,   0,   0,   0,   0, 159,   0, 127,   0],
        [  0,   0,   0,   0,   8,   0,   0,   0, 255,   0,  85,   0, 212,   0,  42,   0,   0,   0,   0,   0,   8,   0,   0,   0,  85,   0, 170,   0, 127,   0,  42,   0],
        [ 28,   0, 198,   0,  56,   0,  56,   0, 226,   0,  28,   0, 141,   0,  28,   0,  28,   0, 170,   0,  28,   0,  28,   0, 255,   0, 113,   0,  85,   0,  85,   0],
        [  0,   0, 127,   0,   0,   0,   0,   0, 255,   0, 191,   0,  31,   0,  63,   0,   0,   0,  95,   0,   0,   0,   0,   0, 223,   0,   0,   0,  31,   0, 159,   0]],

       [[255,   0,   0,   0,   0, 113,   0,   0,  85,   0,   0,   0,   0, 226,   0,   0, 141,   0,   0,   8,   0, 170,  56,  56, 198,   0,   0,  56,   0, 141,  28,   0],
        [  0,   0,   0,   0, 109,   0,   8,   0,  72,   0,   0,   0, 255,   0, 182,   0,   0,   0,   0,   0, 145,   0,   8,   0,  36,   0,   8,   0, 218,   0, 182,   0],
        [  0,   0,  51,  25,  76,  25,  25,   0, 153,   0,   0,   0, 127, 102, 178,   0, 204,   0,   0,   0,   0,   0, 255,   0,   0,   0, 102,   0, 229,   0,  76,   0],
        [  0,   0,   0,   0,   0,   0,   0,   0, 255,   0, 145,   0, 109,   0, 218,   0,  36,   0, 182,   0,  72,   0,  72,   0, 255,   0,   0,   0,   0,   0, 109,   0],
        [255,   0,  85,   0,   0,   0,   0,   0, 226,   0,  85,   0,   0,   0, 198,   0,   0,   0, 141,   0,  56,   0,   0,   0, 170,   0,  28,   0,   0,   0, 113,   0]]
];


q[\drumMap][\hihat] = #[
	   [[255,   0,   0,   0, 145,   0,   0,   0, 182,   0, 109,   0, 109,   0, 109,   0, 218,   0,   0,   0,  72,   0,   0,   0, 182,   0,  72,   0, 182,   0,  36,   0],
        [255,   0,  31,   0,  63,   0,  31,   0,  95,   0,  31,   0,  63,   0, 127,   0, 159,   0,  31,   0,  63,   0,  31,   0, 223,   0, 223,   0, 191,   0, 191,   0],
        [170,   0, 113,   0, 255,   0,  56,   0, 170,   0, 141,   0, 198,   0,  56,   0, 170,   0, 113,   0, 226,   0,  28,   0, 170,   0, 113,   0, 198,   0,  85,   0],
        [115,   0,  46,   0, 255,   0, 185,   0, 139,   0,  23,   0, 208,   0, 115,   0, 231,   0,  69,   0, 255,   0, 162,   0, 139,   0, 115,   0, 231,   0,  92,   0],
        [145,   0, 109, 109, 218, 109,  72,   0, 145,   0,  72,   0, 218,   0, 109,   0, 182,   0, 109,   0, 255,   0,  72,   0, 182, 109,  36, 109, 255, 109, 109,   0]],

       [[255,   0,  28,   0, 226,   0,  56,   0, 198,   0,   0,   0,   0,   0,  28,  28, 170,   0,   0,   0, 141,   0,   0,   0, 113,   0,   0,   0,  85,  85,  85,  85],
        [255,   0,  72,   0, 218,   0,  36,   0, 218,   0,   0,   0, 145,   0,   0,   0, 255,   0,  36,   0, 182,   0,  36,   0, 182,   0,   0,   0, 109,   0,   0,   0],
        [255,   0, 162,   0, 231,   0, 162,   0, 231,   0, 115,   0, 208,   0, 139,   0, 185,   0,  92,   0, 185,   0,  46,   0, 162,   0,  69,   0, 162,   0,  23,   0],
        [255,   0,  42,   0, 233,   0,  63,   0, 212,   0,  85,   0, 191,   0, 106,   0, 191,   0,  21,   0, 170,   0,   8,   0, 170,   0, 127,   0, 148,   0, 148,   0],
        [255,   0, 226,   0, 255,   0, 255,   0, 198,   0,  28,   0, 141,   0,  56,   0, 170,   0,  56,   0,  85,   0,  28,   0, 170,   0,  28,   0, 113,   0,  56,   0]],

       [[255,   0,   0,   0, 255,   0, 127,   0,   0,   0,  85,   0,   0,   0, 212,   0,   0,   0, 212,   0,  42,   0, 170,   0,   0,   0, 127,   0,   0,   0,   0,   0],
        [212,   0,   8,   0, 170,   0,   0,   0, 127,   0,   0,   0,  85,   0,   8,   0, 255,   0,   8,   0, 170,   0,   0,   0, 127,   0,   0,   0,  42,   0,   8,   0],
        [ 76,   0,  25,   0, 255,   0, 127,   0, 153,   0,  51,   0, 204,   0, 102,   0,  76,   0,  51,   0, 229,   0, 127,   0, 153,   0,  51,   0, 178,   0, 102,   0],
        [178,   0, 102,   0, 255,   0,  76,   0, 127,   0,  76,   0, 229,   0,  76,   0, 153,   0, 102,   0, 255,   0,  25,   0, 127,   0,  51,   0, 204,   0,  51,   0],
        [255,   0, 231,   0, 255,   0, 208,   0, 139,   0,  92,   0, 115,   0,  92,   0, 185,   0,  69,   0,  46,   0,  46,   0, 162,   0,  23,   0, 208,   0,  46,   0]],

       [[255,   0, 255,   0, 204, 204, 204, 204,   0,   0,  51,  51,  51,  51,   0,   0, 204,   0, 204,   0, 153, 153, 153, 153, 153,   0,   0,   0, 102, 102, 102, 102],
        [141,   0,  28,   0,  28,   0,  28,   0, 113,   0,   8,   0,   8,   0,   8,   0, 255,   0,   0,   0, 226,   0,   0,   0, 198,   0,  56,   0, 170,   0,  85,   0],
        [109,   0, 109,   0, 255,   0,   0,   0,  72,   0,  72,   0, 218,   0,   0,   0, 145,   0, 182,   0, 255,   0,   0,   0,  36,   0,  36,   0, 218,   0,   8,   0],
        [159,   0, 159,   0, 255,   0,  63,   0, 159,   0, 159,   0, 191,   0,  31,   0, 159,   0, 127,   0, 255,   0,  31,   0, 159,   0, 127,   0, 223,   0,  95,   0],
        [255,   0,  85,   0, 148,   0,  85,   0, 127,   0,  85,   0, 106,   0,  63,   0, 212,   0, 170,   0, 191,   0, 170,   0,  85,   0,  42,   0, 233,   0,  21,   0]],

       [[255,   0,   0,   0,   0, 191,   0,   0, 159,   0,   0,   0,   0, 223,   0,   0,  95,   0,   0,   0,   0,  63,   0,   0, 127,   0,   0,   0,   0,  31,   0,   0],
        [255,   0,   0,   0,   0,   0, 226,   0,  85,   0,   0,   0, 141,   0,   0,   0,   0,   0,   0,   0, 170,   0,  56,   0, 198,   0,   0,   0, 113,   0,  28,   0],
        [113,   0,   0,   0, 141,   0,  85,   0,   0,   0,   0,   0, 170,   0,   0,   0,  56,  28, 255,   0,   0,   0,   0,   0, 198,   0,   0,   0, 226,   0,   0,   0],
        [ 36,   0,  36,   0, 145,   0,   0,   0,  72,   0,  72,   0, 182,   0,   0,   0,  72,   0,  72,   0, 218,   0,   0,   0, 109,   0, 109,   0, 255,   0,   0,   0],
        [113,   0,  56,   0, 255,   0,   0,   0,  85,   0,  56,   0, 226,   0,   0,   0,   0,   0, 170,   0,   0,   0, 141,   0,  28,   0,  28,   0, 198,   0,  28,   0]]
];
)


(
~calculateMap = {|instrument, curBeat, x=0.0, y=0.0, bias=0.0|
	var iBetween, jBetween, level;
	// make sure we stick in 0..31
	curBeat = curBeat%32;

	x = x.clip(0, 1);
	y = y.clip(0, 1);

	// get relevant map indices so 0..1 gets mapped to 0..3
	// b/c drum map is 5x5 and we have a window of 2x2 so
	// we need to respect the offset
	i = x.div(0.25).clip(0, 3);
	j = y.div(0.25).clip(0, 3);

	// get values from the 4 (2x2) maps
	a = q[\drumMap][instrument][i][j][curBeat];
	b = q[\drumMap][instrument][i+1][j][curBeat];
	c = q[\drumMap][instrument][i][j+1][curBeat];
	d = q[\drumMap][instrument][i+1][j+1][curBeat];

	// calc the position between the two maps
	iBetween = (x/0.25)%1;
	jBetween = (y/0.25)%1;

	// calc the mix of the map according to the between positions
	level = (iBetween*a)+((1-iBetween)*b)+(jBetween*c)+((1-jBetween)*d)/2;

	// return the level
	// bias can be seen as adding randomness
	level/256+(bias*256);
}
)


// lets test
(
SynthDef(\kick, {|out|
	var sig = SinOsc.ar(XLine.ar(start: 600,end:  50, dur: 0.1, doneAction: Done.freeSelf))*0.5;
	Out.ar(out, Pan2.ar(sig));
}).add;

SynthDef(\hh, {|out|
	var sig = WhiteNoise.ar*EnvGen.kr(Env.perc(releaseTime: \release.kr(0.2)), doneAction: Done.freeSelf)*\amp.kr(0.5);
	Out.ar(out, Pan2.ar(sig, \pos.kr(0.0)));
}).add;
)

(
t = TempoClock.default;
t.tempo = 130/60.0;
)

(
q[\pattern] = (
	hhX: 0.1,
	hhY: 0.2,
	hhT: 0.6,
	kX: 0.2,
	kY: 0.2,
	kT: 0.7,
	sdX: 0.2,
	sdY: 0.4,
	sdT: 0.6,
);

g = EnvirGui(q[\pattern], numItems:  9);
q[\pattern].keys.do({|key|
	g.putSpec(key, [0.0, 1.0])
});
)

(
Tdef(\hh, {
	inf.do({|i|
		var level = ~calculateMap.(
			instrument: \hihat,
			curBeat: i,
			x: q[\pattern][\hhX],
			y: q[\pattern][\hhY],
		);
		if(level>q[\pattern][\hhT], {
			(
				instrument: \hh,
				amp: level,
				release: 0.01,
			).play;
		});
		(0.125/2).wait;
	});
}).clock_(t).play;

Tdef(\kick, {
	inf.do({|i|
		var level = ~calculateMap.(
			instrument: \kick,
			curBeat: i,
			x: q[\pattern][\kX],
			y: q[\pattern][\kY],
		);
		if(level>q[\pattern][\kT], {
			(
				instrument: \kick,
				amp: level,
			).play;
		});
		(0.125/2).wait;
	});
}).clock_(t).play;

Tdef(\snare, {
	inf.do({|i|
		var level = ~calculateMap.(
			instrument: \snare,
			curBeat: i,
			x: q[\pattern][\sdX],
			y: q[\pattern][\sdY],
		);
		if(level>q[\pattern][\sdT], {
			(
				instrument: \hh,
				amp: level,
				release: 0.1,
			).play;
		});
		(0.125/2).wait;
	});
}).clock_(t).play;
)
